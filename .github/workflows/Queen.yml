name: Queen â™›

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: queen-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Queen.m3u (VOD only, source sanitized)
        run: |
          set -e

          # -------- SAFETY CHECK --------
          [ -d Queen ] || { echo "âŒ Queen folder not found"; exit 1; }

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "ðŸ”¹ Building Queen.m3u at $timestamp"

          # -------- HEADER --------
          {
            echo '#EXTM3U name="RJMS" playlist-name="RJMS OTT" billed-msg="RJMS - RJMBTS Network"'
            echo '#EXT-X-PLAYLIST-TYPE:VOD'
            echo '# Pushed and Updated by Kittujk'
            echo '# Scripted & Maintained by @RJMBTS'
            echo "# Last updated: $timestamp"
          } > Queen.m3u

          # -------- COLLECT SOURCES --------
          find Queen -maxdepth 1 -type f -iname "*.m3u" ! -iname "live.m3u" | sort > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "âŒ No Queen sources found"
            exit 1
          fi

          # -------- MERGE + SANITIZE --------
          while read -r file; do
            echo "âœ… Processing $file"

            awk '
            BEGIN {
              IGNORECASE=1
              skip=0
              is_vod=0
            }

            # -------- DROP ORPHAN TITLE LINES --------
            /^[^#].*tvg-type=/ {
              next
            }

            # ---------------- EXTINF ----------------
            /^#EXTINF/ {
              skip=0
              is_vod=0
              line=$0

              # Remove LIVE / catchup / timeshift
              if (line ~ /tvg-type="live"/ || line ~ /catchup/ || line ~ /timeshift/) {
                skip=1
                next
              }

              # ---- FIX misplaced tvg-type after comma ----
              if (line ~ /,.*tvg-type="/) {
                match(line, /tvg-type="[^"]*"/, t)
                gsub(/ t?v?g?-?type="[^"]*"/, "", line)
                sub(/,/, " " t[0] ",", line)
              }

              # ---- FORCE tvg-type="vod" BEFORE comma ----
              if (line ~ /tvg-type=/) {
                gsub(/tvg-type="[^"]*"/, "tvg-type=\"vod\"", line)
              } else if (line ~ /,/) {
                sub(/,/, " tvg-type=\"vod\",", line)
              } else {
                line = line " tvg-type=\"vod\""
              }

              is_vod=1
              print line
              next
            }

            # ---------------- STREAM URL ----------------
            /^[^#]/ {
              # Kill LIVE protocols
              if ($0 ~ /^udp:\/\// || $0 ~ /^rtp:\/\// || $0 ~ /^rtmp:\/\//) {
                skip=1
              }

              # Block .ts unless VOD
              if ($0 ~ /\.ts(\?|$)/ && is_vod==0) {
                skip=1
              }

              # Block .m3u8 unless VOD
              if ($0 ~ /\.m3u8(\?|$)/ && is_vod==0) {
                skip=1
              }

              if (skip==0) print
              skip=0
              next
            }

            # ---------------- CLEAN META ----------------
            !/^#EXTM3U|pushed and updated by|scripted & maintained|join telegram|^# Total/ {
              print
            }
            ' "$file" >> Queen.m3u

            printf "\n" >> Queen.m3u
          done < "$tmpdir/sources.txt"

          # -------- FINAL SANITATION --------
          sed -i '/^udp:\/\//d;/^rtp:\/\//d;/^rtmp:\/\//d' Queen.m3u

          # -------- TOTAL COUNT --------
          total_count=$(grep -c '^#EXTINF' Queen.m3u || true)

          sed -i '/^# Total :/d' Queen.m3u
          sed -i "/^# Scripted & Maintained/a # Total : Media Library - $total_count" Queen.m3u

          rm -rf "$tmpdir"

          echo "âœ… Done â†’ Total VOD items: $total_count"

      - name: Commit and push Queen.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Queen.m3u
          if git diff --cached --quiet; then
            echo "No changes detected â€” skipping commit."
            exit 0
          fi

          git commit -m "Auto-update Queen.m3u (VOD only, sanitized)"
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "ðŸ‘‘ Queen â™› updated successfully"
          echo "ðŸ“ VOD-only playlist (clean metadata)"
          echo "ðŸš« Live / broken entries removed"
