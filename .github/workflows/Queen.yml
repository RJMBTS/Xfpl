name: Queen â™›

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

concurrency:
  group: queen-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Queen.m3u (VOD only + Recently Added)
        run: |
          set -e

          RECENT_COUNT=50

          [ -d Queen ] || { echo "âŒ Queen folder not found"; exit 1; }

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "ðŸ”¹ Building Queen.m3u at $timestamp"

          # ---------- HEADER ----------
          {
            echo '#EXTM3U name="RJMS" playlist-name="RJMS" billed-msg="RJMS - RJMBTS Network"'
            echo '#EXT-X-PLAYLIST-TYPE:VOD'
            echo '# Pushed and Updated by Kittujk'
            echo '# Scripted & Maintained by @RJMBTS'
            echo "# Last updated: $timestamp"
          } > Queen.m3u

          # ---------- SOURCES ----------
          find Queen -maxdepth 1 -type f -iname "*.m3u" ! -iname "live.m3u" | sort > "$tmpdir/sources.txt"
          [ -s "$tmpdir/sources.txt" ] || { echo "âŒ No sources found"; exit 1; }

          recent_raw="$tmpdir/recent_raw.txt"
          merged_raw="$tmpdir/merged_raw.txt"
          > "$recent_raw"
          > "$merged_raw"

          # ---------- MERGE + SANITIZE ----------
          while read -r file; do
            echo "âœ… Processing $file"
            ts=$(git log -1 --format="%ct" -- "$file" 2>/dev/null || stat -c %Y "$file")

            awk -v TS="$ts" '
            BEGIN { IGNORECASE=1; skip=0; is_vod=0 }

            /^[^#].*tvg-type=/ { next }

            /^#EXTINF/ {
              skip=0; is_vod=0
              line=$0

              if (line ~ /tvg-type="live"|catchup|timeshift/) { skip=1; next }

              if (line ~ /,.*tvg-type="/) {
                match(line, /tvg-type="[^"]*"/, t)
                gsub(/ t?v?g?-?type="[^"]*"/, "", line)
                sub(/,/, " " t[0] ",", line)
              }

              if (line ~ /tvg-type=/)
                gsub(/tvg-type="[^"]*"/, "tvg-type=\"vod\"", line)
              else
                sub(/,/, " tvg-type=\"vod\",", line)

              is_vod=1
              print line >> "'"$merged_raw"'"
              print TS "|" line >> "'"$recent_raw"'"
              next
            }

            /^[^#]/ {
              if ($0 ~ /^(udp|rtp|rtmp):\/\//) { skip=1 }
              if (($0 ~ /\.ts(\?|$)/ || $0 ~ /\.m3u8(\?|$)/) && is_vod==0) { skip=1 }

              if (skip==0) {
                print >> "'"$merged_raw"'"
                print TS "|" $0 >> "'"$recent_raw"'"
              }
              skip=0
              next
            }
            ' "$file"

            printf "\n" >> "$merged_raw"
          done < "$tmpdir/sources.txt"

          # ---------- RECENTLY ADDED ----------
          {
            echo "# ===== RECENTLY ADDED ====="
            sort -nr "$recent_raw" \
              | head -n $((RECENT_COUNT*2)) \
              | cut -d'|' -f2-
            echo ""
            echo "# ===== FULL LIBRARY ====="
          } >> Queen.m3u

          # ---------- FULL LIBRARY ----------
          cat "$merged_raw" >> Queen.m3u

          # ---------- FINAL CLEAN ----------
          sed -i '/^udp:\/\//d;/^rtp:\/\//d;/^rtmp:\/\//d' Queen.m3u
          awk '!seen[$0]++' Queen.m3u > "$tmpdir/final.m3u"
          mv "$tmpdir/final.m3u" Queen.m3u

          total=$(grep -c '^#EXTINF' Queen.m3u || true)
          sed -i '/^# Total :/d' Queen.m3u
          sed -i "/^# Scripted & Maintained/a # Total : Media Library - $total" Queen.m3u

          rm -rf "$tmpdir"
          echo "âœ… Done â†’ Total VOD items: $total"

      - name: Commit and push Queen.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Queen.m3u
          if git diff --cached --quiet; then
            echo "No changes detected â€” skipping commit."
            exit 0
          fi

          git commit -m "Auto-update Queen.m3u (VOD + Recently Added)"
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "ðŸ‘‘ Queen â™› updated successfully"
          echo "ðŸ†• Recently Added section enabled"
          echo "ðŸŽ¬ VOD-only, sanitized playlist"
