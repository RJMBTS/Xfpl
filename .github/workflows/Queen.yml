name: Queen â™›

on:
  schedule:
    - cron: '0 */4 * * *'   # Runs every 4 hours
  workflow_dispatch:

concurrency:
  group: queen-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Queen.m3u (VOD only, LIVE auto-removed)
        run: |
          set -e

          # Safety check
          [ -d Queen ] || { echo "âŒ Queen folder not found"; exit 1; }

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "ðŸ”¹ Building Queen.m3u at $timestamp"

          # ---------------- HEADER ----------------
          {
            echo '#EXTM3U name="RJMS" playlist-name="RJMS OTT" billed-msg="RJMS - RJMBTS Network"'
            echo '#EXT-X-PLAYLIST-TYPE:VOD'
            echo '# Pushed and Updated by Kittujk'
            echo '# Scripted & Maintained by @RJMBTS'
            echo '# Total : Media Library - 0'
            echo "# Last updated: $timestamp"
          } > Queen.m3u

          # -------- COLLECT SOURCE FILES (exclude Live.m3u) --------
          find Queen -maxdepth 1 -type f -iname "*.m3u" ! -iname "live.m3u" | sort > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "âŒ No Queen sources found"
            exit 1
          fi

          # -------- MERGE + FILTER (VOD ONLY) --------
          while read -r file; do
            echo "âœ… Processing $file"

            awk '
              BEGIN { IGNORECASE=1; skip=0; is_vod=0 }

              /^#EXTINF/ {
                skip=0
                is_vod=0
                line=$0

                # Detect LIVE metadata
                if (line ~ /tvg-type="live"/ || line ~ /catchup/ || line ~ /timeshift/) {
                  skip=1
                  next
                }

                # Force VOD type
                if (line ~ /tvg-type=/) {
                  gsub(/tvg-type="[^"]*"/,"tvg-type=\"vod\"",line)
                } else {
                  line=line" tvg-type=\"vod\""
                }

                is_vod=1
                print line
                next
              }

              /^[^#]/ {
                # Remove only true LIVE protocols
                if ($0 ~ /^udp:\/\// || $0 ~ /^rtp:\/\// || $0 ~ /^rtmp:\/\//) {
                  skip=1
                }

                # Allow .ts ONLY if this item is VOD
                if ($0 ~ /\.ts(\?|$)/ && is_vod==0) {
                  skip=1
                }

                if (skip==0) print
                skip=0
                next
              }

              !/^#EXTM3U|pushed and updated by|scripted & maintained|join telegram|^# Total/ {
                print
              }
            ' "$file" >> Queen.m3u

            printf "\n" >> Queen.m3u
          done < "$tmpdir/sources.txt"

          # -------- FINAL SANITATION (LOGIC SAFE) --------
          sed -i '/^udp:\/\//d;/^rtp:\/\//d;/^rtmp:\/\//d' Queen.m3u

          # -------- TOTAL COUNT --------
          total_count=$(grep -c '^#EXTINF' Queen.m3u || true)

          sed -i '/^# Total :/d' Queen.m3u
          sed -i "5i # Total : Media Library - $total_count" Queen.m3u

          echo "âœ… Done â†’ Total VOD items: $total_count"

      - name: Commit and push Queen.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Queen.m3u
          if git diff --cached --quiet; then
            echo "No changes detected â€” skipping commit."
            exit 0
          fi

          git commit -m "Auto-update Queen.m3u (VOD only, RJMS)"
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "ðŸ‘‘ Queen â™› updated successfully"
          echo "ðŸ“ All content forced to VOD / Media Library"
          echo "ðŸš« Live streams removed automatically"
