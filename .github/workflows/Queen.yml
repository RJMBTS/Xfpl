name: Queen â™›

on:
  schedule:
    - cron: '30 3 * * *'   # Daily at 09:00 AM IST
  workflow_dispatch:

concurrency:
  group: queen-m3u
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Queen.m3u with proper categories
        run: |
          set -e

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S %Z")
          tmpdir=$(mktemp -d)

          echo "ðŸ”¹ Building Queen.m3u at $timestamp"

          # Header with RJMS branding (ALL CAPS)
          {
            echo '#EXTM3U name="RJMS" playlist-name="RJMS OTT" billed-msg="RJMS - RJMBTS Network"'
            echo "# Pushed and Updated by Kittujk"
            echo "# Scripted & Maintained by @RJMBTS"
            echo "# Total : Movies - 0 | Web Series - 0 | TV Series - 0"
            echo "# Last updated: $timestamp"
          } > Queen.m3u

          # Collect Queen sources except live.m3u
          find Queen -maxdepth 1 -type f -name "*.m3u" ! -name "live.m3u" | sort > "$tmpdir/sources.txt"

          if [ ! -s "$tmpdir/sources.txt" ]; then
            echo "âŒ No Queen sources found (excluding live.m3u)"
            exit 1
          fi

          # Normalize group-title while merging
          while read -r file; do
            echo "âœ… Processing $file"

            awk '
              BEGIN{IGNORECASE=1}
              /^#EXTINF/ {
                line=$0
                if (line ~ /movie/) {
                  gsub(/group-title="[^"]*"/, "group-title=\"Movies\"", line)
                } else if (line ~ /web/) {
                  gsub(/group-title="[^"]*"/, "group-title=\"Web Series\"", line)
                } else if (line ~ /tv|series/) {
                  gsub(/group-title="[^"]*"/, "group-title=\"TV Series\"", line)
                }
                print line
                next
              }
              !/^#EXTM3U|pushed and updated by|scripted & maintained|join telegram|^# Total/ {
                print
              }
            ' "$file" >> Queen.m3u

            echo "" >> Queen.m3u
          done < "$tmpdir/sources.txt"

          # Category-wise counts
          movies_count=$(grep -i 'group-title="Movies"' Queen.m3u | wc -l || true)
          webseries_count=$(grep -i 'group-title="Web Series"' Queen.m3u | wc -l || true)
          tvseries_count=$(grep -i 'group-title="TV Series"' Queen.m3u | wc -l || true)

          # Update header with counts
          sed -i "/# Total :/c\# Total : Movies - $movies_count | Web Series - $webseries_count | TV Series - $tvseries_count" Queen.m3u

          echo "âœ… Done â†’ Movies:$movies_count | Web:$webseries_count | TV:$tvseries_count"

      - name: Commit and push Queen.m3u
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add Queen.m3u
          if git diff --cached --quiet; then
            echo "No changes detected â€” skipping commit."
            exit 0
          fi

          git commit -m "Auto-update Queen.m3u (RJMS branding)"
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "âœ… Queen â™› updated successfully"
